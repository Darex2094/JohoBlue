# Base Image: Fedora Kinoite 43
FROM quay.io/fedora-ostree-desktops/kinoite:43

# Identify OS as JohoBlue
LABEL "org.opencontainers.image.title"="JohoBlue"
LABEL "org.opencontainers.image.description"="A Customized Fedora Kinoite 43 Derivative"
LABEL "org.opencontainers.image.vendor"="JohoBlue Project"

# Kernel Swap
# We are replacing the Fedora kernel with Sentry's fsync kernel for gaming performance.
# Swapped out DNF method for curl method due to API error
RUN curl -Lo /etc/yum.repos.d/sentry-kernel-blu.repo \
    https://copr.fedorainfracloud.org/coprs/sentry/kernel-blu/repo/fedora-43/sentry-kernel-blu-fedora-43.repo && \
    curl -Lo /etc/yum.repos.d/sentry-xone.repo \
    https://copr.fedorainfracloud.org/coprs/sentry/xone/repo/fedora-43/sentry-xone-fedora-43.repo

RUN rpm-ostree override replace \
    --experimental \
    --from repo='copr:copr.fedorainfracloud.org:sentry:kernel-blu' \
    kernel kernel-core kernel-modules kernel-modules-core kernel-modules-extra

# Xbox Wireless Adapter Support
# We need to create a shim to stop akmod from autocompiling modules before we manipulate userland
RUN rpm-ostree install akmods gcc make kernel-devel

RUN mv /usr/bin/akmods /usr/bin/akmods.real && \
    echo -e '#!/bin/sh\nexit 0' > /usr/bin/akmods && \
    chmod +x /usr/bin/akmods && \
    # Install the driver package
    rpm-ostree install akmod-xone xone-kmod-common && \
    # Restore the real binary
    mv /usr/bin/akmods.real /usr/bin/akmods   

# Perform the actual build properly
RUN chmod -R 777 /var/cache/akmods && \
    # Build as the 'akmods' user to satisfy security checks
    runuser -u akmods -- akmods --force --kernels $(rpm -q kernel-core --queryformat '%{VERSION}-%{RELEASE}.%{ARCH}') && \
    # Install the actual kernel module we just built
    rpm-ostree install /var/cache/akmods/xone/kmod-xone*.rpm && \
    # Cleanup build dependencies
    rpm-ostree uninstall gcc make kernel-devel

# Add the Chrome and RPMFusion repos
RUN echo -e "[google-chrome]\nname=google-chrome\nbaseurl=http://dl.google.com/linux/chrome/rpm/stable/x86_64\nenabled=1\ngpgcheck=1\ngpgkey=https://dl.google.com/linux/linux_signing_key.pub" > /etc/yum.repos.d/google-chrome.repo && \
    rpm-ostree install \
        https://mirrors.rpmfusion.org/free/fedora/rpmfusion-free-release-$(rpm -E %fedora).noarch.rpm \
        https://mirrors.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-$(rpm -E %fedora).noarch.rpm

# Core Package Swap
# Firefox -> Google Chrome Stable
# Toolbox -> Distrobox
# Adding multimedia codecs and power management tools
RUN rpm-ostree override remove firefox toolbox && \
    rpm-ostree install \
        google-chrome-stable \
        distrobox \
        tlp \
        power-profiles-daemon \
        # Multimedia Codecs (RPMFusion)
        gstreamer1-plugin-libav \
        gstreamer1-plugins-bad-free-extras \
        gstreamer1-plugins-bad-freeworld \
        gstreamer1-plugins-ugly \
        gstreamer1-vaapi

# Services
RUN systemctl enable tlp.service